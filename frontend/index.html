<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="SpinningLab - Professional cycling performance analytics platform">
  <title>Login - SpinningLab</title>
  
  <!-- Preconnect to improve performance -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  
  <!-- Inter Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  
  <!-- AUTH PAGE CSS ONLY - Separate from dashboard styles -->
  <link rel="stylesheet" href="/static/css/auth.css">
  
  <!-- Feather Icons -->
  <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
</head>
<body>
  <!-- Notification Container -->
  <div class="notification" id="notification">
    <div class="notification-content">
      <div class="notification-icon">
        <svg id="notificationIcon" fill="none" stroke="currentColor" viewBox="0 0 24 24"></svg>
      </div>
      <div class="notification-message" id="notificationMessage"></div>
    </div>
  </div>

  <!-- Auth Background Container -->
  <div class="auth-background">
    <div class="auth-container">
      <!-- Header -->
      <div class="auth-header">
        <div class="logo" style="gap: 20px;">
          <svg viewBox="0 0 100 100" width="140" height="140" class="spinning-lab-logo">
            <defs>
              <linearGradient id="authLogoGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#667eea;stop-opacity:1" />
                <stop offset="50%" style="stop-color:#764ba2;stop-opacity:1" />
                <stop offset="100%" style="stop-color:#f093fb;stop-opacity:1" />
              </linearGradient>
              <filter id="authGlow">
                <feGaussianBlur stdDeviation="2" result="coloredBlur"/>
                <feMerge>
                  <feMergeNode in="coloredBlur"/>
                  <feMergeNode in="SourceGraphic"/>
                </feMerge>
              </filter>
            </defs>

            <!-- Animated outer ring -->
            <circle cx="50" cy="50" r="45" fill="none" stroke="url(#authLogoGradient)" stroke-width="1.5" opacity="0.2">
              <animate attributeName="r" values="45;47;45" dur="4s" repeatCount="indefinite"/>
              <animate attributeName="opacity" values="0.2;0.1;0.2" dur="4s" repeatCount="indefinite"/>
            </circle>

            <!-- Orbiting metric icons (counter-rotate to wheel) -->
            <g class="auth-orbiting-icons" style="transform-origin: 50px 50px; animation: auth-orbit 40s linear infinite;">
              <!-- Icon 1: Home -->
              <g transform="translate(50, 8)">
                <circle r="5.5" fill="rgba(102, 126, 234, 0.3)"/>
                <path d="M-2 0.7 L0 -1.3 L2 0.7 V2.7 H0.7 V1.3 H-0.7 V2.7 H-2 Z" fill="url(#authLogoGradient)" stroke="none"/>
              </g>
              <!-- Icon 2: Trending Up (30°) -->
              <g transform="translate(73, 14.5)">
                <circle r="5.5" fill="rgba(118, 75, 162, 0.3)"/>
                <path d="M0.7 2 L2 0.7 M2 0.7 L2 2 M2 0.7 L0.7 0.7 M-2 2 L0 0" stroke="url(#authLogoGradient)" stroke-width="1" fill="none" stroke-linecap="round"/>
              </g>
              <!-- Icon 3: Activity (60°) -->
              <g transform="translate(85.5, 35.5)">
                <circle r="5.5" fill="rgba(240, 147, 251, 0.3)"/>
                <path d="M-2.7 0.7 L-1.3 0.7 L0 -2 L1.3 2 L2.7 0" stroke="url(#authLogoGradient)" stroke-width="1" fill="none" stroke-linecap="round"/>
              </g>
              <!-- Icon 4: Target (90°) -->
              <g transform="translate(92, 50)">
                <circle r="5.5" fill="rgba(102, 126, 234, 0.3)"/>
                <circle cx="0" cy="0" r="2.3" fill="none" stroke="url(#authLogoGradient)" stroke-width="1"/>
                <circle cx="0" cy="0" r="1" fill="url(#authLogoGradient)"/>
              </g>
              <!-- Icon 5: Percent (120°) -->
              <g transform="translate(85.5, 64.5)">
                <circle r="5.5" fill="rgba(118, 75, 162, 0.3)"/>
                <path d="M-1.3 2 L1.3 -2 M-1.3 -1.3 a0.5 0.5 0 1 0 0.02 0 M1.3 1.3 a0.5 0.5 0 1 0 0.02 0" stroke="url(#authLogoGradient)" stroke-width="1" fill="none"/>
              </g>
              <!-- Icon 6: Award (150°) -->
              <g transform="translate(73, 85.5)">
                <circle r="5.5" fill="rgba(240, 147, 251, 0.3)"/>
                <circle cx="0" cy="-0.3" r="1.7" fill="none" stroke="url(#authLogoGradient)" stroke-width="1"/>
                <path d="M-1 1 L-0.7 2.3 L0 1.7 L0.7 2.3 L1 1" fill="url(#authLogoGradient)" stroke="none"/>
              </g>
              <!-- Icon 7: Layers (180°) -->
              <g transform="translate(50, 92)">
                <circle r="5.5" fill="rgba(102, 126, 234, 0.3)"/>
                <path d="M0 -2 L2 -1 L0 0 L-2 -1 Z M0 0 L2 1 L0 2 L-2 1 Z" fill="url(#authLogoGradient)" stroke="none"/>
              </g>
              <!-- Icon 8: Heart (210°) -->
              <g transform="translate(27, 85.5)">
                <circle r="5.5" fill="rgba(118, 75, 162, 0.3)"/>
                <path d="M0 2 L-1.7 0.5 Q-2 -0.3 -1.3 -1 Q-0.7 -1.7 0 -0.7 Q0.7 -1.7 1.3 -1 Q2 -0.3 1.7 0.5 Z" fill="url(#authLogoGradient)" stroke="none"/>
              </g>
              <!-- Icon 9: Wind (240°) -->
              <g transform="translate(14.5, 64.5)">
                <circle r="5.5" fill="rgba(240, 147, 251, 0.3)"/>
                <path d="M-2 -1 L1.3 -1 Q2 -1 2 -0.3 M-2 1 L0.7 1 Q1.3 1 1.3 1.7" stroke="url(#authLogoGradient)" stroke-width="1" fill="none" stroke-linecap="round"/>
              </g>
              <!-- Icon 10: Thermometer (270°) -->
              <g transform="translate(8, 50)">
                <circle r="5.5" fill="rgba(102, 126, 234, 0.3)"/>
                <path d="M0 -2 L0 0.5 M-1 1.3 Q0 2.3 1 1.3 Q1.3 0.7 1 0 L0.5 0 L0.5 -2 L-0.5 -2 L-0.5 0 L-1 0 Q-1.3 0.7 -1 1.3 Z" fill="url(#authLogoGradient)" stroke="none"/>
              </g>
              <!-- Icon 11: List (300°) -->
              <g transform="translate(14.5, 35.5)">
                <circle r="5.5" fill="rgba(118, 75, 162, 0.3)"/>
                <path d="M-0.7 -1.7 L2 -1.7 M-0.7 0 L2 0 M-0.7 1.7 L2 1.7 M-2 -1.7 L-1.7 -1.7 M-2 0 L-1.7 0 M-2 1.7 L-1.7 1.7" stroke="url(#authLogoGradient)" stroke-width="1" stroke-linecap="round"/>
              </g>
              <!-- Icon 12: Upload (330°) -->
              <g transform="translate(27, 14.5)">
                <circle r="5.5" fill="rgba(240, 147, 251, 0.3)"/>
                <path d="M0 -2 L0 2 M0 -2 L-1.3 -0.7 M0 -2 L1.3 -0.7" stroke="url(#authLogoGradient)" stroke-width="1" fill="none" stroke-linecap="round"/>
              </g>
            </g>

            <!-- Main spinning wheel -->
            <g class="auth-spin" style="transform-origin: 50px 50px; animation: auth-spin 20s linear infinite;">
              <!-- Outer rim -->
              <circle cx="50" cy="50" r="28" fill="none" stroke="url(#authLogoGradient)" stroke-width="3" filter="url(#authGlow)"/>

              <!-- 6 spokes -->
              <line x1="50" y1="22" x2="50" y2="78" stroke="url(#authLogoGradient)" stroke-width="2.5"/>
              <line x1="22" y1="50" x2="78" y2="50" stroke="url(#authLogoGradient)" stroke-width="2.5"/>
              <line x1="30.2" y1="30.2" x2="69.8" y2="69.8" stroke="url(#authLogoGradient)" stroke-width="2.5"/>
              <line x1="69.8" y1="30.2" x2="30.2" y2="69.8" stroke="url(#authLogoGradient)" stroke-width="2.5"/>

              <!-- Inner hub -->
              <circle cx="50" cy="50" r="8" fill="url(#authLogoGradient)"/>
              <circle cx="50" cy="50" r="5" fill="none" stroke="white" stroke-width="1.5" opacity="0.5"/>
            </g>
          </svg>
          <h1>SpinningLab</h1>
        </div>
        <p class="tagline">Where data meets performance</p>
      </div>

      <style>
        @keyframes auth-spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }

        @keyframes auth-orbit {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(-360deg); }
        }

        .spinning-lab-logo {
          display: block;
        }
      </style>

      <!-- Tab Navigation -->
      <div class="tab-navigation">
        <button class="tab-btn active" data-tab="login">
          <svg class="tab-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"/>
          </svg>
          <span>Login</span>
        </button>
        <button class="tab-btn" data-tab="register">
          <svg class="tab-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/>
          </svg>
          <span>Register</span>
        </button>
      </div>

      <!-- Tab Container -->
      <div class="tab-container">
        <!-- Login Tab -->
        <div class="tab-content active" id="loginTab">
          <form class="auth-form" id="loginForm">
            <div class="form-group">
              <label for="loginEmail">Email Address</label>
              <div class="input-wrapper">
                <svg class="input-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                </svg>
                <input 
                  type="email" 
                  id="loginEmail" 
                  placeholder="you@example.com" 
                  required
                  autocomplete="email"
                >
              </div>
            </div>

            <div class="form-group">
              <label for="loginPassword">Password</label>
              <div class="input-wrapper">
                <svg class="input-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                </svg>
                <input 
                  type="password" 
                  id="loginPassword" 
                  placeholder="••••••••" 
                  required
                  autocomplete="current-password"
                >
              </div>
            </div>

            <button type="submit" class="auth-btn" id="loginBtn">
              <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"/>
              </svg>
              <span class="btn-text">Sign In</span>
              <svg class="btn-loader" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10" stroke-width="4" stroke="currentColor" fill="none" opacity="0.25"/>
                <path d="M12 2a10 10 0 0110 10" stroke="currentColor" stroke-width="4" fill="none"/>
              </svg>
            </button>
          </form>
        </div>

        <!-- Register Tab -->
        <div class="tab-content" id="registerTab">
          <form class="auth-form" id="registerForm">
            <div class="form-group">
              <label for="registerName">
                Full Name 
                <span class="optional">(optional)</span>
              </label>
              <div class="input-wrapper">
                <svg class="input-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                </svg>
                <input 
                  type="text" 
                  id="registerName" 
                  placeholder="John Doe"
                  autocomplete="name"
                >
              </div>
            </div>

            <div class="form-group">
              <label for="registerEmail">Email Address</label>
              <div class="input-wrapper">
                <svg class="input-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                </svg>
                <input 
                  type="email" 
                  id="registerEmail" 
                  placeholder="you@example.com" 
                  required
                  autocomplete="email"
                >
              </div>
            </div>

            <div class="form-group">
              <label for="registerPassword">Password</label>
              <div class="input-wrapper">
                <svg class="input-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                </svg>
                <input 
                  type="password" 
                  id="registerPassword" 
                  placeholder="••••••••" 
                  required
                  autocomplete="new-password"
                  minlength="6"
                >
              </div>
            </div>

            <button type="submit" class="auth-btn" id="registerBtn">
              <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/>
              </svg>
              <span class="btn-text">Create Account</span>
              <svg class="btn-loader" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10" stroke-width="4" stroke="currentColor" fill="none" opacity="0.25"/>
                <path d="M12 2a10 10 0 0110 10" stroke="currentColor" stroke-width="4" fill="none"/>
              </svg>
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Auth JavaScript -->
  <script type="module">
    import { TOKEN_STORAGE_KEY } from './static/js/core/config.js';
    import { AuthAPI } from './static/js/core/api.js';

    // Tab Switching
    const tabBtns = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');

    tabBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        const targetTab = btn.dataset.tab;
        
        // Update buttons
        tabBtns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        // Update content
        tabContents.forEach(content => {
          content.classList.remove('active');
          if (content.id === `${targetTab}Tab`) {
            content.classList.add('active');
          }
        });
      });
    });

    // Notification Helper
    function showNotification(message, type = 'error') {
      const notification = document.getElementById('notification');
      const messageEl = document.getElementById('notificationMessage');
      const iconEl = document.getElementById('notificationIcon');
      
      messageEl.textContent = message;
      notification.className = `notification ${type}`;
      
      // Set icon based on type
      if (type === 'error') {
        iconEl.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"/>';
      } else {
        iconEl.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>';
      }
      
      notification.classList.add('show');
      setTimeout(() => notification.classList.remove('show'), 4000);
    }

    // Button Loading State
    function setButtonLoading(btn, loading) {
      const text = btn.querySelector('.btn-text');
      const icon = btn.querySelector('.btn-icon');
      const loader = btn.querySelector('.btn-loader');
      
      if (loading) {
        btn.disabled = true;
        text.style.display = 'none';
        icon.style.display = 'none';
        loader.style.display = 'block';
      } else {
        btn.disabled = false;
        text.style.display = 'inline';
        icon.style.display = 'block';
        loader.style.display = 'none';
      }
    }

    // Login Form Handler - FIXED TO USE AuthAPI
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const btn = document.getElementById('loginBtn');
      const email = document.getElementById('loginEmail').value.trim();
      const password = document.getElementById('loginPassword').value;
      
      setButtonLoading(btn, true);
      
      try {
        console.log('[Login] Attempting login with email:', email);
        
        // Use AuthAPI.login which correctly handles FormData for OAuth2
        const data = await AuthAPI.login(email, password);
        
        if (!data || !data.access_token) {
          throw new Error('No access token received from server');
        }
        
        // Store token
        localStorage.setItem(TOKEN_STORAGE_KEY, data.access_token);
        console.log('[Login] Token stored successfully');
        
        // Verify token by fetching user info
        const user = await AuthAPI.me();
        console.log('[Login] User authenticated:', user.username);
        
        showNotification('Login successful! Redirecting...', 'success');
        
        // Redirect to dashboard
        setTimeout(() => {
          window.location.href = '/dashboard.html';
        }, 1000);
        
      } catch (error) {
        console.error('[Login] Login failed:', error);
        const message = error?.message || 'Login failed. Please check your credentials.';
        showNotification(message, 'error');
        
        // Clear any partial tokens
        localStorage.removeItem(TOKEN_STORAGE_KEY);
      } finally {
        setButtonLoading(btn, false);
      }
    });

    // Register Form Handler - FIXED TO USE AuthAPI
    document.getElementById('registerForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const btn = document.getElementById('registerBtn');
      const name = document.getElementById('registerName').value.trim();
      const email = document.getElementById('registerEmail').value.trim();
      const password = document.getElementById('registerPassword').value;
      
      // Validation
      if (!email || !password) {
        showNotification('Please fill in all required fields', 'error');
        return;
      }
      
      if (password.length < 6) {
        showNotification('Password must be at least 6 characters', 'error');
        return;
      }
      
      setButtonLoading(btn, true);
      
      try {
        console.log('[Register] Attempting registration with email:', email);
        
        // Create username from email or name
        const username = name || email.split('@')[0];
        
        // Use AuthAPI.register
        await AuthAPI.register(username, email, password);
        
        console.log('[Register] Registration successful');
        showNotification('Registration successful! Please login.', 'success');
        
        // Switch to login tab and prefill email
        setTimeout(() => {
          document.querySelector('[data-tab="login"]').click();
          document.getElementById('loginEmail').value = email;
          document.getElementById('loginPassword').focus();
        }, 1500);
        
      } catch (error) {
        console.error('[Register] Registration failed:', error);
        const message = error?.message || 'Registration failed. Please try again.';
        showNotification(message, 'error');
      } finally {
        setButtonLoading(btn, false);
      }
    });

    // Check if already logged in on page load
    const token = localStorage.getItem(TOKEN_STORAGE_KEY);
    if (token) {
      console.log('[Auth] Existing token found, verifying...');
      
      AuthAPI.me()
        .then(user => {
          console.log('[Auth] Token valid, redirecting to dashboard');
          window.location.href = '/dashboard.html';
        })
        .catch(error => {
          console.log('[Auth] Token invalid, clearing:', error.message);
          localStorage.removeItem(TOKEN_STORAGE_KEY);
        });
    }

    // Initialize Feather Icons
    if (typeof feather !== 'undefined') {
      feather.replace();
      console.log('[Auth] Feather icons initialized');
    }
  </script>
</body>
</html>