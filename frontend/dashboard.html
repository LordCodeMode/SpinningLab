<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="SpinningLab - Professional cycling performance analytics dashboard">
  <title>Dashboard - SpinningLab</title>
  
  <!-- Preconnect to improve performance -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  
  <!-- Inter Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
  
  <!-- SINGLE CSS IMPORT - main.css imports everything else in correct order -->
  <link rel="stylesheet" href="/static/css/main.css">
  
  <!-- Feather Icons -->
  <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>

  <!-- Strava OAuth code handler: move ?code into hash so SPA can process it -->
  <script>
    (function() {
      try {
        const search = window.location.search;
        if (search && search.includes('code=')) {
          const query = search.startsWith('?') ? search.slice(1) : search;
          const targetHash = window.location.hash.split('?')[0] || '#/settings';
          const newUrl = `${window.location.pathname}${targetHash}?${query}`;
          window.history.replaceState({}, document.title, newUrl);
        }
      } catch (e) {
        console.warn('Strava code handler failed:', e);
      }
    })();
  </script>
  
  <style>
    /* CRITICAL: Ensure Feather icons are always visible */
    .sidebar i[data-feather],
    .nav-item i[data-feather],
    .sidebar-brand i[data-feather],
    .user-avatar i[data-feather],
    .logout-btn i[data-feather] {
      display: inline-flex !important;
      width: 20px;
      height: 20px;
      stroke: currentColor;
      stroke-width: 2;
      stroke-linecap: round;
      stroke-linejoin: round;
      fill: none;
    }

    /* Make SVG icons visible */
    .sidebar svg,
    .nav-item svg {
      display: block !important;
      pointer-events: none;
    }

    /* Brand logo styling */
    .brand-logo {
      flex-shrink: 0;
    }

    .sidebar-spinning-wheel {
      animation: sidebar-spin 20s linear infinite;
    }

    .sidebar-orbiting-icons {
      animation: sidebar-orbit 40s linear infinite;
    }

    @keyframes sidebar-spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @keyframes sidebar-orbit {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(-360deg); }
    }

    /* Ensure logout button is clickable */
    .logout-btn {
      cursor: pointer;
      pointer-events: all !important;
    }
  </style>

</head>
<body>
  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loading-overlay" style="display: none;">
    <div class="loading-spinner"></div>
  </div>

  <!-- Notification Container -->
  <div class="notification" id="notification"></div>

  <!-- App Container -->
  <div class="app-container">
    
    <!-- ========== COLLAPSIBLE SIDEBAR ========== -->
    <aside class="sidebar" id="sidebar">
      <!-- Sidebar Header -->
      <div class="sidebar-header">
        <div class="sidebar-brand">
          <svg class="brand-logo" viewBox="0 0 50 50" width="32" height="32">
            <defs>
              <linearGradient id="logoGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#667eea;stop-opacity:1" />
                <stop offset="50%" style="stop-color:#764ba2;stop-opacity:1" />
                <stop offset="100%" style="stop-color:#f093fb;stop-opacity:1" />
              </linearGradient>
            </defs>

            <!-- Orbiting metric icons (smaller, counter-rotate) -->
            <g class="sidebar-orbiting-icons" style="transform-origin: 25px 25px;">
              <!-- Icon 1: Home -->
              <g transform="translate(25, 4)" opacity="0.7">
                <circle r="3" fill="rgba(102, 126, 234, 0.35)"/>
                <path d="M-1.2 0.4 L0 -0.7 L1.2 0.4 V1.5 H0.4 V0.7 H-0.4 V1.5 H-1.2 Z" fill="url(#logoGradient)" stroke="none"/>
              </g>
              <!-- Icon 2: Trending Up -->
              <g transform="translate(37, 7.5)" opacity="0.7">
                <circle r="3" fill="rgba(118, 75, 162, 0.35)"/>
                <path d="M0.4 1.2 L1.2 0.4 M1.2 0.4 L1.2 1.2 M1.2 0.4 L0.4 0.4 M-1.2 1.2 L0 0" stroke="url(#logoGradient)" stroke-width="0.5" fill="none" stroke-linecap="round"/>
              </g>
              <!-- Icon 3: Activity -->
              <g transform="translate(43, 17.5)" opacity="0.7">
                <circle r="3" fill="rgba(240, 147, 251, 0.35)"/>
                <path d="M-1.4 0.4 L-0.7 0.4 L0 -1.2 L0.7 1.2 L1.4 0" stroke="url(#logoGradient)" stroke-width="0.5" fill="none" stroke-linecap="round"/>
              </g>
              <!-- Icon 4: Target -->
              <g transform="translate(46, 25)" opacity="0.7">
                <circle r="3" fill="rgba(102, 126, 234, 0.35)"/>
                <circle cx="0" cy="0" r="1.1" fill="none" stroke="url(#logoGradient)" stroke-width="0.5"/>
                <circle cx="0" cy="0" r="0.4" fill="url(#logoGradient)"/>
              </g>
              <!-- Icon 5: Percent -->
              <g transform="translate(43, 32.5)" opacity="0.7">
                <circle r="3" fill="rgba(118, 75, 162, 0.35)"/>
                <path d="M-0.7 1.2 L0.7 -1.2 M-0.7 -0.7 a0.3 0.3 0 1 0 0.01 0 M0.7 0.7 a0.3 0.3 0 1 0 0.01 0" stroke="url(#logoGradient)" stroke-width="0.5" fill="none"/>
              </g>
              <!-- Icon 6: Award -->
              <g transform="translate(37, 42.5)" opacity="0.7">
                <circle r="3" fill="rgba(240, 147, 251, 0.35)"/>
                <circle cx="0" cy="-0.2" r="0.9" fill="none" stroke="url(#logoGradient)" stroke-width="0.5"/>
                <path d="M-0.6 0.5 L-0.4 1.3 L0 0.9 L0.4 1.3 L0.6 0.5" fill="url(#logoGradient)" stroke="none"/>
              </g>
              <!-- Icon 7: Layers -->
              <g transform="translate(25, 46)" opacity="0.7">
                <circle r="3" fill="rgba(102, 126, 234, 0.35)"/>
                <path d="M0 -1.2 L1.2 -0.6 L0 0 L-1.2 -0.6 Z M0 0 L1.2 0.6 L0 1.2 L-1.2 0.6 Z" fill="url(#logoGradient)" stroke="none"/>
              </g>
              <!-- Icon 8: Heart -->
              <g transform="translate(13, 42.5)" opacity="0.7">
                <circle r="3" fill="rgba(118, 75, 162, 0.35)"/>
                <path d="M0 1.2 L-0.9 0.3 Q-1.1 -0.1 -0.7 -0.5 Q-0.4 -0.8 0 -0.4 Q0.4 -0.8 0.7 -0.5 Q1.1 -0.1 0.9 0.3 Z" fill="url(#logoGradient)" stroke="none"/>
              </g>
              <!-- Icon 9: Wind -->
              <g transform="translate(7, 32.5)" opacity="0.7">
                <circle r="3" fill="rgba(240, 147, 251, 0.35)"/>
                <path d="M-1.2 -0.5 L0.7 -0.5 Q1.1 -0.5 1.1 -0.1 M-1.2 0.5 L0.4 0.5 Q0.7 0.5 0.7 0.9" stroke="url(#logoGradient)" stroke-width="0.5" fill="none" stroke-linecap="round"/>
              </g>
              <!-- Icon 10: Thermometer -->
              <g transform="translate(4, 25)" opacity="0.7">
                <circle r="3" fill="rgba(102, 126, 234, 0.35)"/>
                <path d="M0 -1.2 L0 0.3 M-0.6 0.7 Q0 1.3 0.6 0.7 Q0.8 0.4 0.6 0 L0.3 0 L0.3 -1.2 L-0.3 -1.2 L-0.3 0 L-0.6 0 Q-0.8 0.4 -0.6 0.7 Z" fill="url(#logoGradient)" stroke="none"/>
              </g>
              <!-- Icon 11: List -->
              <g transform="translate(7, 17.5)" opacity="0.7">
                <circle r="3" fill="rgba(118, 75, 162, 0.35)"/>
                <path d="M-0.4 -0.9 L1.2 -0.9 M-0.4 0 L1.2 0 M-0.4 0.9 L1.2 0.9 M-1.2 -0.9 L-1 -0.9 M-1.2 0 L-1 0 M-1.2 0.9 L-1 0.9" stroke="url(#logoGradient)" stroke-width="0.5" stroke-linecap="round"/>
              </g>
              <!-- Icon 12: Upload -->
              <g transform="translate(13, 7.5)" opacity="0.7">
                <circle r="3" fill="rgba(240, 147, 251, 0.35)"/>
                <path d="M0 -1.2 L0 1.2 M0 -1.2 L-0.7 -0.5 M0 -1.2 L0.7 -0.5" stroke="url(#logoGradient)" stroke-width="0.5" fill="none" stroke-linecap="round"/>
              </g>
            </g>

            <!-- Main spinning wheel with 6 spokes -->
            <g class="sidebar-spinning-wheel" style="transform-origin: 25px 25px;">
              <circle cx="25" cy="25" r="13" fill="none" stroke="url(#logoGradient)" stroke-width="2"/>
              <line x1="25" y1="12" x2="25" y2="38" stroke="url(#logoGradient)" stroke-width="1.5"/>
              <line x1="12" y1="25" x2="38" y2="25" stroke="url(#logoGradient)" stroke-width="1.5"/>
              <line x1="15.8" y1="15.8" x2="34.2" y2="34.2" stroke="url(#logoGradient)" stroke-width="1.5"/>
              <line x1="34.2" y1="15.8" x2="15.8" y2="34.2" stroke="url(#logoGradient)" stroke-width="1.5"/>
              <!-- Center hub -->
              <circle cx="25" cy="25" r="4" fill="url(#logoGradient)"/>
              <circle cx="25" cy="25" r="2" fill="none" stroke="white" stroke-width="0.8" opacity="0.5"/>
            </g>
          </svg>
          <span>SpinningLab</span>
        </div>
      </div>

      <!-- Sidebar Navigation -->
      <nav class="sidebar-nav">
        <!-- Dashboard Section -->
        <div class="nav-section">
          <div class="nav-section-title">Dashboard</div>
          <a href="#overview" class="nav-item active" data-page="overview">
            <i data-feather="home"></i>
            <span>Overview</span>
          </a>
        </div>

        <!-- Performance Section -->
        <div class="nav-section">
          <div class="nav-section-title">Performance</div>
          <a href="#training-load" class="nav-item" data-page="training-load">
            <i data-feather="trending-up"></i>
            <span>Training Load</span>
          </a>
          <a href="#power-curve" class="nav-item" data-page="power-curve">
            <i data-feather="activity"></i>
            <span>Power Curve</span>
          </a>
          <a href="#critical-power" class="nav-item" data-page="critical-power">
            <i data-feather="target"></i>
            <span>Critical Power</span>
          </a>
          <a href="#efficiency" class="nav-item" data-page="efficiency">
            <i data-feather="percent"></i>
            <span>Efficiency</span>
          </a>
          <a href="#best-powers" class="nav-item" data-page="best-powers">
            <i data-feather="award"></i>
            <span>Best Powers</span>
          </a>
        </div>

        <!-- Analysis Section -->
        <div class="nav-section">
          <div class="nav-section-title">Analysis</div>
          <a href="#zones" class="nav-item" data-page="zones">
            <i data-feather="layers"></i>
            <span>Power Zones</span>
          </a>
          <a href="#hr-zones" class="nav-item" data-page="hr-zones">
            <i data-feather="heart"></i>
            <span>HR Zones</span>
          </a>
          <a href="#vo2max" class="nav-item" data-page="vo2max">
            <i data-feather="wind"></i>
            <span>VO2 Max</span>
          </a>
          <a href="#fitness-state" class="nav-item" data-page="fitness-state">
            <i data-feather="thermometer"></i>
            <span>Fitness State</span>
          </a>
        </div>

        <!-- Data Section -->
        <div class="nav-section">
          <div class="nav-section-title">Data</div>
          <a href="#activities" class="nav-item" data-page="activities">
            <i data-feather="list"></i>
            <span>Activities</span>
          </a>
          <a href="#upload" class="nav-item" data-page="upload">
            <i data-feather="upload"></i>
            <span>Upload</span>
          </a>
          <a href="#settings" class="nav-item" data-page="settings">
            <i data-feather="settings"></i>
            <span>Settings</span>
          </a>
        </div>
      </nav>

      <!-- Sidebar Footer -->
      <div class="sidebar-footer">
        <div class="user-info">
          <div class="user-avatar" id="user-avatar">
            <i data-feather="user"></i>
          </div>
          <span id="userEmail" title="Current user">User</span>
        </div>
        <button class="logout-btn" id="logout-btn" title="Logout" aria-label="Logout">
          <i data-feather="log-out"></i>
        </button>
      </div>
    </aside>

    <!-- ========== MAIN CONTENT ========== -->
    <main class="main-content" id="main-content">
      <!-- Main Header -->
      <header class="main-header">
        <div>
          <h1 id="page-title">Overview</h1>
          <p id="page-subtitle" style="font-size: 15px; color: #64748b; margin-top: 4px; font-weight: 500;"></p>
        </div>
        <div class="header-actions">
          <button class="btn btn--secondary btn--sm" id="refresh-btn" title="Refresh Page">
            <i data-feather="refresh-cw" style="width: 16px; height: 16px;"></i>
            <span>Refresh</span>
          </button>
          <button class="btn btn--primary btn--sm" id="upload-btn-header" title="Upload Activities">
            <i data-feather="upload" style="width: 16px; height: 16px;"></i>
            <span>Upload</span>
          </button>
        </div>
      </header>

      <!-- Content Wrapper - Pages are loaded here dynamically -->
      <div id="pageContent">
        <!-- Dynamic page content will be injected here by JavaScript -->
        <div style="padding: 60px 20px; text-align: center; color: #94a3b8;">
          <div class="loading-spinner" style="margin: 0 auto 20px;"></div>
          <p style="font-size: 15px; font-weight: 500;">Loading dashboard...</p>
        </div>
      </div>
    </main>
  </div>

  <!-- ========== JAVASCRIPT MODULES ========== -->
  <!-- Core utilities - Load first -->
  <script type="module" src="/static/js/core/config.js"></script>
  <script type="module" src="/static/js/core/eventBus.js"></script>
  <script type="module" src="/static/js/core/state.js"></script>
  <script type="module" src="/static/js/core/utils.js"></script>
  <script type="module" src="/static/js/core/api.js"></script>
  
  <!-- Router -->
  <script type="module" src="/static/js/core/router.js"></script>
  
  <!-- Main dashboard controller - Load last -->
  <script type="module" src="/static/js/core/dashboard.js"></script>

  <!-- Initialize Feather Icons - CRITICAL FOR ICON VISIBILITY -->
  <script>
    // Initialize immediately
    function initFeatherIcons() {
      if (typeof feather !== 'undefined') {
        feather.replace();
        console.log('[Dashboard] Feather icons initialized');
      } else {
        console.error('[Dashboard] Feather icons library not loaded!');
      }
    }
    
    // Initialize on DOM ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initFeatherIcons);
    } else {
      initFeatherIcons();
    }
    
    // Re-initialize after slight delay to catch dynamic content
    setTimeout(() => {
      if (typeof feather !== 'undefined') {
        feather.replace();
        console.log('[Dashboard] Feather icons re-initialized');
      }
    }, 200);
    
    // Watch for DOM changes and re-initialize icons
    if (typeof MutationObserver !== 'undefined') {
      const observer = new MutationObserver(() => {
        if (typeof feather !== 'undefined') {
          feather.replace();
        }
      });
      
      // Start observing after DOM is ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
          observer.observe(document.body, {
            childList: true,
            subtree: true
          });
        });
      } else {
        observer.observe(document.body, {
          childList: true,
          subtree: true
        });
      }
    }
    
    // Mobile sidebar functionality
    document.addEventListener('DOMContentLoaded', () => {
      const sidebar = document.getElementById('sidebar');
      
      if (sidebar) {
        // Close sidebar when clicking outside on mobile
        document.addEventListener('click', (e) => {
          if (window.innerWidth <= 1024) {
            if (!sidebar.contains(e.target)) {
              sidebar.classList.remove('mobile-open');
            }
          }
        });
        
        // Prevent clicks inside sidebar from closing it
        sidebar.addEventListener('click', (e) => {
          e.stopPropagation();
        });
      }
      
      // Additional check for logout button
      const logoutBtn = document.getElementById('logout-btn');
      if (logoutBtn) {
        console.log('[Dashboard HTML] Logout button found in DOM');
      } else {
        console.error('[Dashboard HTML] Logout button NOT found in DOM!');
      }
      
      console.log('[Dashboard HTML] Page initialized successfully');
    });
  </script>
</body>
</html>
